name: Deploy

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

permissions:
  contents: read

jobs:
  resolve-env:
    name: Resolve Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Determine environment
        id: env
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ "$TAG" == *"-dev"* ]]; then
            echo "environment=dev" >> "$GITHUB_OUTPUT"
          else
            echo "environment=production" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          VERSION="${VERSION%-dev}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy
    needs: resolve-env
    runs-on: ubuntu-latest
    environment: ${{ needs.resolve-env.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            api/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend && npm ci
          cd ../api && npm ci

      - name: Build frontend
        run: cd frontend && npm run build
        env:
          VITE_APP_VERSION: ${{ needs.resolve-env.outputs.version }}

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: frontend/dist
          api_location: api
          skip_app_build: true
